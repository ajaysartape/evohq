<!DOCTYPE html>
<html>
<head>
  <title>EvoHQ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      background: #0E1117;
      color: #E5E7EB;
      font-family: Arial, sans-serif;
    }

    .topbar {
      height: 60px;
      background: #161B22;
      display: flex;
      align-items: center;
      padding: 0 20px;
      font-weight: bold;
      border-bottom: 1px solid #222;
    }

    .layout {
      display: flex;
      height: calc(100vh - 60px);
    }

    .sidebar {
      width: 300px;
      background: #161B22;
      padding: 20px;
      border-right: 1px solid #222;
      overflow-y: auto;
    }

    .update-item {
      padding: 12px;
      border-bottom: 1px solid #222;
    }

    .update-item button {
      margin-top: 6px;
      margin-right: 6px;
    }

    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    .card {
      background: #161B22;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 6px;
      border: 1px solid #222;
    }

    h2 { color: #2563EB; }
    h3 { color: #9CA3AF; }
    ul { padding-left: 20px; }

    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #2563EB;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-success {
      background: #102a1f;
      border: 1px solid #1f5138;
      color: #4ade80;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
    }

    .status-error {
      background: #2a1010;
      border: 1px solid #512020;
      color: #f87171;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<div class="topbar">EvoHQ â€“ AI Content Engine</div>

<div class="layout">

  <div class="sidebar">
    <h3>Updates</h3>
    <div id="update-list"></div>
  </div>

  <div class="content">
    <div id="status-message"></div>
    <div id="content">
      <p>Select an update to view bundle.</p>
    </div>
  </div>

</div>

<script>

  // ðŸ”¥ REPLACE THESE 3
  const SUPABASE_URL = "https://zfxxunulbvflgnurdedc.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmeHh1bnVsYnZmbGdudXJkZWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzI1MjksImV4cCI6MjA4NzAwODUyOX0.hzMAMIFrJsX1X6I1VYucDastFOQRQqT409hOT3es9lQ";
  
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let isLoading = false;

  function showStatus(message, type = "success") {
    const box = document.getElementById("status-message");
    box.className = type === "success" ? "status-success" : "status-error";
    box.innerText = message;
    setTimeout(() => {
      box.innerText = "";
      box.className = "";
    }, 3000);
  }

  async function loadUpdates() {
    const { data } = await client
      .from('updates')
      .select('*')
      .order('created_at', { ascending: false });

    document.getElementById("update-list").innerHTML =
      data.map(update => `
        <div class="update-item">
          <strong>${update.title}</strong><br/>
          <small>${update.category} | Impact: ${update.impact_score}</small><br/>
          <button onclick="generateBundle('${update.id}','${update.title}')">Generate</button>
          <button onclick="loadBundle('${update.id}')">View</button>
        </div>
      `).join("");
  }

  function getPrompt(title) {
    return `
Return ONLY valid JSON in this exact structure:

{
  "article": {
    "headline": "string",
    "subheading": "string",
    "sections": {
      "whats_new": ["string"],
      "key_features": ["string"],
      "why_it_matters": "string"
    }
  },
  "video": {
    "script_lines": ["string"],
    "duration_seconds": 8
  },
  "images": {
    "featured_text": "string",
    "carousel_slides": ["string"],
    "thumbnail_text": "string"
  },
  "web_story": {
    "slides": ["string"]
  },
  "social": {
    "linkedin": "string",
    "x_thread": ["string"],
    "instagram_caption": "string",
    "youtube_description": "string"
  }
}

Topic: ${title}
`;
  }

  async function regenerateBundle(bundleId, updateId, title) {

  if (isLoading) return;
  isLoading = true;

  document.getElementById("content").innerHTML =
    `<div class="card">Regenerating... <span class="spinner"></span></div>`;

  try {

    const response = await fetch(
      "https://zfxxunulbvflgnurdedc.functions.supabase.co/generate-bundle",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "apikey": SUPABASE_KEY
        },
        body: JSON.stringify({ title })
      }
    );

    const data = await response.json();

    if (!data.bundle) {
      showStatus("AI returned invalid structure.", "error");
      isLoading = false;
      return;
    }

    const bundle = data.bundle;

    await client
      .from("content_bundle")
      .update({
        article_json: bundle.article,
        video_json: bundle.video,
        images_json: bundle.images,
        web_story_json: bundle.web_story,
        social_json: bundle.social
      })
      .eq("id", bundleId);

    showStatus("Draft regenerated.");
    loadBundle(updateId);

  } catch (err) {
    console.error(err);
    showStatus("Error regenerating.", "error");
  }

  isLoading = false;
}



  async function generateBundle(updateId, title) {

  if (isLoading) return;
  isLoading = true;

  document.getElementById("content").innerHTML =
    `<div class="card">Generating... <span class="spinner"></span></div>`;

  try {

    const response = await fetch(
      "https://zfxxunulbvflgnurdedc.functions.supabase.co/generate-bundle",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "apikey": SUPABASE_KEY
        },
        body: JSON.stringify({ title })
      }
    );

    const data = await response.json();

    if (!data.bundle) {
      showStatus("AI returned invalid structure.", "error");
      isLoading = false;
      return;
    }

    const bundle = data.bundle;

    await client.from("content_bundle").insert({
      update_id: updateId,
      article_json: bundle.article,
      video_json: bundle.video,
      images_json: bundle.images,
      web_story_json: bundle.web_story,
      social_json: bundle.social,
      status: "draft"
    });

    showStatus("Bundle generated.");
    loadBundle(updateId);

  } catch (err) {
    console.error(err);
    showStatus("Error generating content.", "error");
  }

  isLoading = false;
}


  async function publishBundle(bundleId, updateId) {

    await client
      .from("content_bundle")
      .update({ status: "published" })
      .eq("id", bundleId);

    showStatus("Published successfully.");
    loadBundle(updateId);
  }

  async function loadBundle(updateId) {

    const { data } = await client
      .from("content_bundle")
      .select('*')
      .eq("update_id", updateId)
      .order("created_at", { ascending: false })
      .limit(1);

    if (!data.length) return;

    const bundle = data.bundle;

if (!bundle) {
  showStatus("AI returned invalid structure.", "error");
  isLoading = false;
  return;
}


    const article = bundle.article_json || {};
    const sections = article.sections || {};

    const statusBadge = bundle.status === "published"
      ? `<span style="color:lightgreen;">Published</span>`
      : `<span style="color:orange;">Draft</span>`;

    const actions = bundle.status === "published"
      ? `<div style="color:lightgreen;">Locked</div>`
      : `
          <button onclick="regenerateBundle('${bundle.id}','${updateId}','${article.headline}')">Regenerate</button>
          <button onclick="publishBundle('${bundle.id}','${updateId}')">Publish</button>
        `;

    document.getElementById("content").innerHTML = `
      <div class="card">
        ${actions}
        <h2>${article.headline || "No headline"} ${statusBadge}</h2>

        <h3>What's New</h3>
        <ul>${(sections.whats_new || []).map(i => `<li>${i}</li>`).join("")}</ul>

        <h3>Key Features</h3>
        <ul>${(sections.key_features || []).map(i => `<li>${i}</li>`).join("")}</ul>

        <h3>Why It Matters</h3>
        <p>${sections.why_it_matters || ""}</p>
      </div>
    `;
  }

  loadUpdates();

</script>

</body>
</html>
